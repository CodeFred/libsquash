# Libsquash

Portable, User-land SquashFS that can be easily linked and embedded within your application; a [squashfuse](https://github.com/vasi/squashfuse) fork.

[![Build status: Linux and Darwin](https://travis-ci.org/enclose-io/libsquash.svg?branch=master)](https://travis-ci.org/enclose-io/libsquash)
[![Build status: Windows](https://ci.appveyor.com/api/projects/status/297rm0xhcfyyu9uo?svg=true)](https://ci.appveyor.com/project/pmq20/libsquash)
[![Coverity Scan](https://scan.coverity.com/projects/11215/badge.svg)](https://scan.coverity.com/projects/enclose-io-libsquash)

## About the fork

This project was forked from https://github.com/vasi/squashfuse with the following modifications.

1. Removed fuse the dependency so that this library can be easily linked and embedded.
1. Read data from the memory instead of from a file,
which is by passing a pointer to an array of bytes that could be generated by
an independently installed [mksquashfs](http://squashfs.sourceforge.net/) tool
and be loaded into memory in advance.
1. Introduced vfd(virtual file descriptor) as a handle for follow-up
libsquash operations. The vfd is a non-negative integer that lives together with
other ordinary file descriptors of the process.
1. Added extra API's, see below.
1. Added CMake so that Xcode and Vistual Studio Projects could be easily generated
1. Made it compile on 3 platforms simultanesly: Windows, Mac OS X and Linux
1. Added travis-ci for Linux and Darwin CI; appveyor for Windows CI; and Coverity Scan
1. Added test fixtures and C-level tests

## Building

On most systems you could build and test the library using the following commands,

    mkdir build
    cd build
    cmake ..
    cmake --build .
    ctest --verbose

## Extra API's

### `squash_open(error, fs, path)`

Opens the file name specified by `path` of `fs` for reading.
If successful, `squash_open()` returns a non-negative integer, termed a vfd(virtual file descriptor).
It returns `-1` on failure and sets `error` to the reason of the error.
The file pointer (used to mark the current position within the file) is set to the beginning of the file.
The returned vfd should later be closed by `squash_close()`.

### `squash_close(error, vfd)`

Deletes a `vfd`(virtual file descriptor) from the per-process object reference table.
Upon successful completion, a value of `0` is returned.
Otherwise, a value of `-1` is returned and `error` is set to the reason of the error.

### `squash_read(error, vfd, buf, nbyte)`

Attempts to read `nbyte` bytes of data from the object
referenced by `vfs` into the buffer pointed to by `buf`,
starting at a position given by the pointer associated with `vfd` (see `squash_lseek`),
which is then incremented by the number of bytes actually read upon return.
When successful it returns the number of bytes actually read and placed in the buffer;
upon reading end-of-file, zero is returned;
Otherwise, a value of `-1` is returned and `error` is set to the reason of the error.

### `squash_lseek(error, vfd, offset, whence)`

Repositions the offset of `vfs` to the argument `offset`, according to the directive `whence`.
If `whence` is `SQUASH_SEEK_SET` then the offset is set to `offset` bytes;
if `whence` is `SQUASH_SEEK_CUR`, the `offset` is set to its current location plus `offset` bytes;
if `whence` is `SQUASH_SEEK_END`, the `offset` is set to the size of the file plus `offset` bytes
and subsequent reads of the data return bytes of zeros.
The argument `fildes` must be an open virtual file descriptor.
Upon successful completion,
it returns the resulting offset location as measured in bytes from the beginning of the file.
Otherwise, a value of `-1` is returned and `error` is set to the reason of the error.

### `squash_valid_vfd(vfd)`

Checks whether provided `vfd` is a valid virtual file descriptor or not, i.e,
whether it was allocated by libsquash or not.

## Acknowledgment

Thank you [Dave Vasilevsky](https://github.com/vasi) for the excellent work of squashfuse!

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/enclose-io/libsquash.

## Contributors

* [pmq20](https://github.com/pmq20) - **Minqi Pan** &lt;pmq2001@gmail.com&gt;

## License

Squashfuse is copyright (c) 2012-2014 Dave Vasilevsky <dave@vasilevsky.ca>

Copyright (c) 2016 Libsquash contributors, under terms of the [MIT License](http://opensource.org/licenses/MIT).
